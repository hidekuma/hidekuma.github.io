
                              ┌──────┐              ┌───────────┐
                              │Server│              │API Gateway│
                              └──┬───┘              └─────┬─────┘
                                 │                        │
                    ╔══════╤═════╪════════════════════════╪═════════════════════════════════════════════════════════════╗
                    ║ ALT  │  Authentication Request      │                                                             ║
                    ╠════════════╪════════════════════════╪═════════════════════════════════════════════════════════════╣
                    ║ [With API Key]                      │                                                             ║
                    ║            │      with API Key      │                                                             ║
                    ║            │ ───────────────────────>                                                             ║
                    ║            │                        │                                                             ║
                    ║            │                        │       call()       ┌──────┐                                 ║
                    ║            │                        │ ──────────────────>│Lambda│                                 ║
                    ║            │                        │                    └──┬───┘                                 ║
                    ║            │                        │ generate presigned url   ╔═══════════════════════╗          ║
                    ║            │                        │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   ║//TTL// = **__300__** ░║          ║
                    ║            │                        │                       │  ╚═══════════════════════╝          ║
                    ║            │ Authentication Response│                       │                                     ║
                    ║            │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─                       │                                     ║
                    ╠════════════╪════════════════════════╪═══════════════════════╪═════════════════════════════════════╣
                    ║ [Without API Key]                   │                       │                                     ║
                    ║            │     without API Key    │                       │                                     ║
                    ║            │ ───────────────────────>                       │                                     ║
                    ║            │                        │                       │                                     ║
                    ║            │      Access Denied     │                       │                                     ║
                    ║            │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─                       │                                     ║
                    ╚════════════╪════════════════════════╪═══════════════════════╪═════════════════════════════════════╝
                                 │                        │                       │
                                 │                        │                       │
          ╔══════╤═══════════════╪════════════════════════╪═══════════════════════╪═════════════════════════════════════════════════════╗
          ║ ALT  │  Upload file or get file from S3       │                       │                                                     ║
          ╟──────┘               │                        │                       │                                                     ║
          ║                      │                        │                       │                                                     ║
          ║         ╔════════════╪═════════════╤══════════╪═══════════════════════╪═══════════════════════════════════════════╗         ║
          ║         ║ AFTER GET PRESIGNED URL  │          │                       │                                           ║         ║
          ║         ╟──────────────────────────┘         use presigned url        │              ┌──┐                         ║         ║
          ║         ║            │ ─────────────────────────────────────────────────────────────>│S3│                         ║         ║
          ║         ║            │                        │                       │              └┬─┘                         ║         ║
          ║         ║            │                        │Access Allowed         │                                           ║         ║
          ║         ║            │ <───────────────────────────────────────────────────────────────                           ║         ║
          ║         ║            │                        │                       │               │                           ║         ║
          ║         ║            │                        │                       │               │                           ║         ║
          ║         ║            │                   ╔════╧═══════════════════════╧══════════╗    │                           ║         ║
═════════════════════════════════╪═══════════════════╣ 5 minutes(//TTL// = **__300__**) later╠════╪════════════════════════════════════════════════
          ║         ║            │                   ╚════╤═══════════════════════╤══════════╝    │                           ║         ║
          ║         ║            │                        │                       │               │                           ║         ║
          ║         ║            │                        │ Access Denied         │               │  ╔═════════════╗          ║         ║
          ║         ║            │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─  ║//expired// ░║          ║         ║
          ║         ╠════════════╪════════════════════════╪═══════════════════════╪═══════════════╪═══════════════════════════╣         ║
          ║         ║ [GET]      │                        │                       │               │                           ║         ║
          ║         ║            │                        GET presigned url       │               │                           ║         ║
          ║         ║            │ ───────────────────────────────────────────────────────────────>                           ║         ║
          ║         ║            │                        │                       │               │                           ║         ║
          ║         ║            │                       Provide a S3 object      │               │                           ║         ║
          ║         ║            │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─                           ║         ║
          ║         ║            │                        │                       │               │                           ║         ║
          ║         ║            │────┐                   │                       │               │                           ║         ║
          ║         ║            │    │ Business logic    │                       │               │                           ║         ║
          ║         ║            │<───┘                   │                       │               │                           ║         ║
          ║         ╠════════════╪════════════════════════╪═══════════════════════╪═══════════════╪═══════════════════════════╣         ║
          ║         ║ [POST]     │                        │                       │               │                           ║         ║
          ║         ║            │              POST presigned url with a upload file             │                           ║         ║
          ║         ║            │ ───────────────────────────────────────────────────────────────>                           ║         ║
          ║         ║            │                        │                       │               │                           ║         ║
          ║         ║            │                        │    Success            │               │                           ║         ║
          ║         ║            │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─                           ║         ║
          ║         ╚════════════╪════════════════════════╪═══════════════════════╪═══════════════╪═══════════════════════════╝         ║
          ╚══════════════════════╪════════════════════════╪═════════════════════════════════════════════════════════════════════════════╝
                              ┌──┴───┐              ┌─────┴─────┐              ┌──┴───┐          ┌┴─┐
                              │Server│              │API Gateway│              │Lambda│          │S3│
                              └──────┘              └───────────┘              └──────┘          └──┘

@startuml
box "User" #LightGray
	participant Server
end box
box "AWS Infra" #LightBlue
	participant "API Gateway"
	participant Lambda
	participant S3
end box


alt Authentication Request
else With API Key
	Server -> "API Gateway": with API Key
	create Lambda
	"API Gateway"-> Lambda : call()
	Lambda --> "API Gateway": generate presigned url
	note right
	  //TTL// = **__300__**
	end note
	"API Gateway" --> Server : Authentication Response
else Without API Key
	Server -> "API Gateway": without API Key
	"API Gateway" --> Server: Access Denied
end


alt Upload file or get file from S3
	group After get presigned url
	create S3
	Server -> S3 : use presigned url
	S3 -> Server : Access Allowed
	...5 minutes(//TTL// = **__300__**) later...
	S3 --> Server : Access Denied
	note right
	  //expired//
	end note
	else GET
		Server -> S3 : GET presigned url
		S3 -->o Server : Provide a S3 object
		Server -> Server : Business logic
	else POST
		Server ->o S3 : POST presigned url with a upload file
		S3 --> Server : Success
	end
end
@enduml
